# Release Workflow: Manual release creation
# - Triggered manually from GitHub Actions UI
# - Downloads pre-built exe from latest master CI build (no rebuild)
# - Auto-increments version or uses custom version
# - Creates Git tag and GitHub Release with exe attached
#
# How to use:
#   1. Go to Actions -> Release -> Run workflow
#   2. (Optional) Specify version (e.g., v1.2.3) or leave empty to auto-increment
#   3. (Optional) Add custom release notes or use defaults
#   4. Click "Run workflow"

name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.2.3). Leave empty to auto-increment patch version'
        required: false
        default: ''
      release_notes:
        description: 'Release notes (optional)'
        required: false
        default: ''

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Determine version
        id: get_version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            # Use provided version
            NEW_VERSION="${{ github.event.inputs.version }}"
            # Ensure it starts with 'v'
            if [[ ! $NEW_VERSION =~ ^v ]]; then
              NEW_VERSION="v${NEW_VERSION}"
            fi
          else
            # Auto-increment patch version
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            VERSION=$(echo $LATEST_TAG | sed 's/v//')
            IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          fi
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Creating release: $NEW_VERSION"

      - name: Download latest master build
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: main.yml
          branch: master
          name: windows-build-master
          path: ./artifacts
          check_artifacts: true
          search_artifacts: true

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.get_version.outputs.new_version }}"

          # Prepare release notes
          if [ -n "${{ github.event.inputs.release_notes }}" ]; then
            NOTES="${{ github.event.inputs.release_notes }}"
          else
            NOTES="Manual release of deej with USB Serial support

          ## Features
          - USB Serial communication (COM port based)
          - Individual mute button events
          - Optimistic UI updates
          - Auto-mute based on slider position

          ## Installation
          1. Download \`deej-release.exe\`
          2. Place it in a folder of your choice
          3. Create a \`config.yaml\` file (see README)
          4. Run \`deej-release.exe\`

          See the [README](https://github.com/${{ github.repository }}/blob/master/README.md) for full documentation."
          fi

          # Create release with gh CLI
          gh release create "$VERSION" \
            ./artifacts/deej-release.exe \
            --title "Release $VERSION" \
            --notes "$NOTES"

          # Add job summary
          echo "### ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Assets" >> $GITHUB_STEP_SUMMARY
          echo "- \`deej-release.exe\` - Ready for download" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ What happened" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Downloaded pre-built exe from latest master CI build" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Created Git tag: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Published GitHub Release with exe attached" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/$VERSION)" >> $GITHUB_STEP_SUMMARY
