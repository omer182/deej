name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.2.3). Leave empty to auto-increment patch version'
        required: false
        default: ''
      release_notes:
        description: 'Release notes (optional)'
        required: false
        default: ''

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Determine version
        id: get_version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            # Use provided version
            NEW_VERSION="${{ github.event.inputs.version }}"
            # Ensure it starts with 'v'
            if [[ ! $NEW_VERSION =~ ^v ]]; then
              NEW_VERSION="v${NEW_VERSION}"
            fi
          else
            # Auto-increment patch version
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            VERSION=$(echo $LATEST_TAG | sed 's/v//')
            IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          fi
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Creating release: $NEW_VERSION"

      - name: Download latest master build
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: main.yml
          branch: master
          name: windows-build-master
          path: ./artifacts
          check_artifacts: true
          search_artifacts: true

      - name: Prepare release notes
        id: release_notes
        run: |
          if [ -n "${{ github.event.inputs.release_notes }}" ]; then
            NOTES="${{ github.event.inputs.release_notes }}"
          else
            NOTES="Manual release of deej with USB Serial support

          ## Features
          - USB Serial communication (COM port based)
          - Individual mute button events
          - Optimistic UI updates
          - Auto-mute based on slider position

          ## Installation
          1. Download \`deej-release.exe\`
          2. Place it in a folder of your choice
          3. Create a \`config.yaml\` file (see README)
          4. Run \`deej-release.exe\`

          See the [README](https://github.com/${{ github.repository }}/blob/master/README.md) for full documentation."
          fi
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.new_version }}
          release_name: Release ${{ steps.get_version.outputs.new_version }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/deej-release.exe
          asset_name: deej-release.exe
          asset_content_type: application/octet-stream
